package com.ymsli.bank.inhouse.service.impl;

import com.ymsli.bank.inhouse.exceptions.InvalidTransactionStateException;
//import com.ymsli.bank.inhouse.dto.TransferRequest;
import com.ymsli.bank.inhouse.model.Account;
import com.ymsli.bank.inhouse.model.Transaction;
import com.ymsli.bank.inhouse.model.enums.TransactionStatus;
import com.ymsli.bank.inhouse.model.enums.TransactionType;
import com.ymsli.bank.inhouse.repository.AccountRepository;
import com.ymsli.bank.inhouse.repository.TransactionRepository;
import com.ymsli.bank.inhouse.service.TransactionService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.time.LocalDateTime;

@Service
public class TransactionServiceImpl implements TransactionService {

    @Autowired
    private AccountRepository accountRepository;

    @Autowired
    private TransactionRepository transactionRepository;

    @Override
    public void deposit(String accountNumber, Double amount, Long clerkId) {

        Account account = accountRepository.findByAccountNumber(accountNumber)
                .orElseThrow(() -> new RuntimeException("Account not found"));

        account.setBalance(account.getBalance() + amount);
        accountRepository.save(account);

        Transaction txn = new Transaction();
        txn.setAccountNumber(accountNumber);
        txn.setType(TransactionType.DEPOSIT);
        txn.setAmount(amount);
        txn.setStatus(TransactionStatus.COMPLETED);
        txn.setTransactionTime(LocalDateTime.now());
        txn.setPerformedBy(clerkId);

        transactionRepository.save(txn);
    }

    @Override
    public void withdraw(String accountNumber, Double amount, Long clerkId) {

        Account account = accountRepository.findByAccountNumber(accountNumber)
                .orElseThrow(() -> new RuntimeException("Account not found"));

        Transaction txn = new Transaction();
        txn.setAccountNumber(accountNumber);
        txn.setType(TransactionType.WITHDRAWAL);
        txn.setAmount(amount);
        txn.setTransactionTime(LocalDateTime.now());
        txn.setPerformedBy(clerkId);

        if (amount <= 200000) {
            account.setBalance(account.getBalance() - amount);
            accountRepository.save(account);
            txn.setStatus(TransactionStatus.COMPLETED);
        } else {
            txn.setStatus(TransactionStatus.PENDING_APPROVAL);
        }

        transactionRepository.save(txn);
    }
    
    
  
    @Override
    public void transfer(String fromAccountNumber,
                         String toAccountNumber,
                         Double amount,
                         Long clerkId) {

        Account fromAccount = accountRepository.findByAccountNumber(fromAccountNumber)
                .orElseThrow(() -> new RuntimeException("Sender's account not found"));

        Account toAccount = accountRepository.findByAccountNumber(toAccountNumber)
                .orElseThrow(() -> new RuntimeException("Receiver's account not found"));

        if(fromAccount.getBalance()<amount){
            throw new RuntimeException("Insufficient Balance");
        }

        // CREATE withdrawal transaction
        Transaction withdrawTxn = new Transaction();
        withdrawTxn.setAccountNumber(fromAccountNumber);
        withdrawTxn.setType(TransactionType.WITHDRAWAL);
        withdrawTxn.setAmount(amount);
        withdrawTxn.setTransactionTime(LocalDateTime.now());
        withdrawTxn.setPerformedBy(clerkId);

        if (amount <= 200000) {
            // Update balances immediately
            fromAccount.setBalance(fromAccount.getBalance() - amount);
            toAccount.setBalance(toAccount.getBalance() + amount);

            accountRepository.save(fromAccount);
            accountRepository.save(toAccount);

            withdrawTxn.setStatus(TransactionStatus.COMPLETED);

            // CREATE deposit transaction
            Transaction depositTxn = new Transaction();
            depositTxn.setAccountNumber(toAccountNumber);
            depositTxn.setType(TransactionType.DEPOSIT);
            depositTxn.setAmount(amount);
            depositTxn.setStatus(TransactionStatus.COMPLETED);
            depositTxn.setTransactionTime(LocalDateTime.now());
            depositTxn.setPerformedBy(clerkId);

            transactionRepository.save(depositTxn);

        } else {
            // High value transfer -> pending approval
            withdrawTxn.setStatus(TransactionStatus.PENDING_APPROVAL);
        }

        transactionRepository.save(withdrawTxn);
    }

	@Override
	public void approveTransaction(Long txnId, Long managerId, boolean approved) {
		 Transaction t = transactionRepository.findById(id)
	                .orElseThrow(() -> new ResourceNotFoundException("Transaction not found"));

	        if (t.getStatus() != TransactionStatus.PENDING_APPROVAL)
	            throw new InvalidTransactionStateException("Not pending");

	        if (!approved) {
	            t.setStatus(TransactionStatus.REJECTED);
	            t.setApprovedBy(managerId);
	            txnRepo.save(t);
	            return;
	        }

	        if (t.getType() == TransactionType.WITHDRAWAL) {
	            Account a = accountRepo.findByAccountNumber(t.getAccountNumber())
	                    .orElseThrow(() -> new ResourceNotFoundException("Account not found"));
	            a.setBalance(a.getBalance() - t.getAmount());
	            accountRepo.save(a);
	        }

	        if (t.getType() == TransactionType.TRANSFER) {
	            Account f = accountRepo.findByAccountNumber(t.getFromAccountNumber()).get();
	            Account to = accountRepo.findByAccountNumber(t.getToAccountNumber()).get();
	            f.setBalance(f.getBalance() - t.getAmount());
	            to.setBalance(to.getBalance() + t.getAmount());
	            accountRepo.save(f);
	            accountRepo.save(to);
	        }

	        t.setStatus(TransactionStatus.COMPLETED);
	        t.setApprovedBy(managerId);
	        txnRepo.save(t);
	    }
		
	}


}
