package com.ymsli.bank.inhouse.service.impl;

import com.ymsli.bank.inhouse.dto.TransferRequest;
import com.ymsli.bank.inhouse.model.Account;
import com.ymsli.bank.inhouse.model.Transaction;
import com.ymsli.bank.inhouse.model.enums.TransactionStatus;
import com.ymsli.bank.inhouse.model.enums.TransactionType;
import com.ymsli.bank.inhouse.repository.AccountRepository;
import com.ymsli.bank.inhouse.repository.TransactionRepository;
import com.ymsli.bank.inhouse.service.TransactionService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.time.LocalDateTime;

@Service
public class TransactionServiceImpl implements TransactionService {

    @Autowired
    private AccountRepository accountRepository;

    @Autowired
    private TransactionRepository transactionRepository;

    @Override
    public void deposit(String accountNumber, Double amount, Long clerkId) {

        Account account = accountRepository.findByAccountNumber(accountNumber)
                .orElseThrow(() -> new RuntimeException("Account not found"));

        account.setBalance(account.getBalance() + amount);
        accountRepository.save(account);

        Transaction txn = new Transaction();
        txn.setAccountNumber(accountNumber);
        txn.setType(TransactionType.DEPOSIT);
        txn.setAmount(amount);
        txn.setStatus(TransactionStatus.COMPLETED);
        txn.setTransactionTime(LocalDateTime.now());
        txn.setPerformedBy(clerkId);

        transactionRepository.save(txn);
    }

    @Override
    public void withdraw(String accountNumber, Double amount, Long clerkId) {

        Account account = accountRepository.findByAccountNumber(accountNumber)
                .orElseThrow(() -> new RuntimeException("Account not found"));

        Transaction txn = new Transaction();
        txn.setAccountNumber(accountNumber);
        txn.setType(TransactionType.WITHDRAWAL);
        txn.setAmount(amount);
        txn.setTransactionTime(LocalDateTime.now());
        txn.setPerformedBy(clerkId);

        if (amount <= 200000) {
            account.setBalance(account.getBalance() - amount);
            accountRepository.save(account);
            txn.setStatus(TransactionStatus.COMPLETED);
        } else {
            txn.setStatus(TransactionStatus.PENDING_APPROVAL);
        }

        transactionRepository.save(txn);
    }
    
    
    @Override
    public void transfer(TransferRequest request) {
        // Withdraw from sender
        if(request.getAmount() <= 200000) {
            // auto approved withdrawal
            withdraw(request.getFromAccountNumber(), request.getAmount(), request.getClerkId());
            // deposit to receiver
            deposit(request.getToAccountNumber(), request.getAmount(), request.getClerkId());
        } else {
            // high-value withdrawal â†’ pending approval
            Transaction tx = new Transaction();
            tx.setAccount(accountRepository.findByAccountNumber(request.getFromAccountNumber())
                    .orElseThrow(() -> new RuntimeException("Sender account not found")));
            tx.setAmount(request.getAmount());
            tx.setTransactionType("TRANSFER_OUT");
            tx.setClerkId(request.getClerkId());
            tx.setStatus("PENDING_APPROVAL");
            transactionRepository.save(tx);

            // Deposit transaction (receiver) stays pending until approval
            Transaction txIn = new Transaction();
            txIn.setAccount(accountRepository.findByAccountNumber(request.getToAccountNumber())
                    .orElseThrow(() -> new RuntimeException("Receiver account not found")));
            txIn.setAmount(request.getAmount());
            txIn.setTransactionType("TRANSFER_IN");
            txIn.setClerkId(request.getClerkId());
            txIn.setStatus("PENDING_APPROVAL");
            transactionRepository.save(txIn);
        }
    }

}
